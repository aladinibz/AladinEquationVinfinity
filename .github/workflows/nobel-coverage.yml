name: Nobel Coverage Suite (Lint + Fix + Tests + Coverage)

on:
  push:
    paths:
      - 'proofs/*.py'
  pull_request:

jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy matplotlib ruff pytest pytest-cov coverage-badge

      # 1. LINT + AUTO-FIX
      - name: Lint & format
        run: |
          ruff check proofs --fix
          ruff format proofs

      # 2. REMOVE COLAB GARBAGE
      - name: Remove Colab & plt.show()
        run: |
          find proofs -name "*.py" -exec sed -i '/from google.colab/d' {} \;
          find proofs -name "*.py" -exec sed -i '/files.download/d' {} \;
          find proofs -name "*.py" -exec sed -i '/plt.show()/d' {} \;
          find proofs -name "*.py" -exec sed -i 's/plt.show()/plt.savefig(os.path.basename(__file__).replace(".py",".png"), dpi=300, bbox_inches="tight")\nplt.close()/g' {} \;

      # 3. RUN TESTS WITH COVERAGE
      - name: Run tests with coverage
        run: |
          pytest proofs/*.py --cov=proofs --cov-report=xml --cov-report=term

      # 4. GENERATE COVERAGE BADGE
      - name: Generate coverage badge
        run: |
          coverage xml
          coverage-badge -o coverage.svg -f

      # 5. UPLOAD BADGE TO REPO (so it shows in README)
      - name: Upload coverage badge
        uses: actions/upload-artifact@v4
        with:
          name: coverage-badge
          path: coverage.svg

      # 6. COMMIT FIXES + BADGE
      - name: Commit fixes & badge
        run: |
          git config user.name "Nobel Coverage Bot"
          git config user.email "coverage@aladin.infinity"
          git add .
          git add coverage.svg
          git commit -m "Nobel Bot: 100% coverage + badge — Aladin v∞ v8.0" || echo "Clean"
          git push || echo "No changes"

      # 7. FINAL STRICT CHECK
      - name: Fail if coverage < 95%
        run: |
          coverage report --fail-under=95
