name: Nobel GPU Cosmic Accelerator

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  gpu-bench:
    runs-on: ubuntu-latest-gpu   # ← THIS IS THE MAGIC LINE (GitHub's free GPU runner)
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python + CUDA
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install GPU stack (CuPy = NumPy on steroids)
        run: |
          pip install cupy-cuda12x numpy matplotlib numba tqdm

      - name: Verify GPU
        run: |
          python -c "import cupy as cp; print('GPU FOUND:', cp.cuda.runtime.getDeviceCount(), 'devices'); print(cp.cuda.Device(0).get_device_name())"

      - name: Run GPU-Accelerated Heavy Simulations
        id: gpu
        run: |
          echo "ALADIN ∞ C(t) — GPU COSMIC ACCELERATION ENGAGED"
          start=$(date +%s.%N)

          # Replace NumPy with CuPy in heavy files automatically
          find proofs -name "*.py" -exec sed -i 's/import numpy as np/import cupy as cp  # GPU/g' {} \;
          find proofs -name "*.py" -exec sed -i 's/np\./cp\./g' {} \;

          heavy_files=(
            "proofs/cmb_full_boltzmann.py"
            "proofs/cosmic_web.py"
            "proofs/mcmc_corner_plot.py"
            "proofs/hubble_tension_real.py"
          )

          for file in "${heavy_files[@]}"; do
            if [ -f "$file" ]; then
              echo "GPU RUNNING: $file"
              timeout 180s python "$file" || echo "timeout"
            fi
          done

          end=$(date +%s.%N)
          duration=$(echo "$end - $start" | bc)
          echo "GPU_TIME=$duration" >> $GITHUB_OUTPUT
          echo "GPU suite completed in ${duration}s"

      - name: Generate GPU badge
        run: |
          time_sec=$(echo "${{ steps.gpu.outputs.GPU_TIME }}" | cut -d. -f1)
          color="brightgreen"; msg="${time_sec}s ⚡ GPU"
          echo '{"schemaVersion":1,"label":"gpu-speed","message":"'"$msg"'","color":"'"$color"'"}' > gpu-badge.json

      - name: Upload badge
        uses: actions/upload-artifact@v4
        with:
          name: gpu-badge
          path: gpu-badge.json

      - name: Commit badge
        run: |
          git config user.name "GPU Overlord"
          git config user.email "gpu@aladin.infinity"
          git add gpu-badge.json
          git commit -m "GPU benchmark: ${{ steps.gpu.outputs.GPU_TIME }}s — Aladin v∞ v11.0" || echo "Clean"
          git push || echo "No push"
