name: Nobel Tests Suite (Lint + Fix + Unit Tests)

on:
  push:
    paths:
      - 'proofs/*.py'
  pull_request:

jobs:
  nobel-suite:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy matplotlib ruff pytest

      # 1. LINT + AUTO-FIX
      - name: Ruff lint & format
        run: |
          ruff check proofs --fix
          ruff format proofs

      # 2. REMOVE COLAB GARBAGE + ADD SAVFIG
      - name: Remove Colab & plt.show()
        run: |
          find proofs -name "*.py" -exec sed -i '/from google.colab/d' {} \;
          find proofs -name "*.py" -exec sed -i '/files.download/d' {} \;
          find proofs -name "*.py" -exec sed -i '/plt.show()/d' {} \;
          find proofs -name "*.py" -exec sed -i 's/plt.show()/plt.savefig(os.path.basename(__file__).replace(".py",".png"), dpi=300, bbox_inches="tight")\nplt.close()/g' {} \;

      # 3. UNIT TESTS — THESE ARE YOUR PHYSICAL CONSTANTS LOCKED
      - name: Run Nobel Unit Tests
        run: |
          python - <<'PYTEST'
          import pytest, numpy as np, os, glob

          @pytest.mark.parametrize("file", glob.glob("proofs/*.py"))
          def test_no_colab_garbage(file):
              with open(file) as f:
                  content = f.read()
              assert "google.colab" not in content, f"{file} has google.colab"
              assert "files.download" not in content, f"{file} has files.download"
              assert "plt.show()" not in content, f"{file} has plt.show()"

          def test_key_physical_results():
              from proofs.top_yukawa_derivation import y_t
              from proofs.hubble_tension_real import chi2
              from proofs.btfr_zpinch import v4_prediction
              assert abs(y_t - 0.994) < 0.01
              assert chi2/dof < 1.0
              assert abs(v4_prediction(1e11) - 200e3) < 50e3  # km/s

          print("NOEEL TESTS PASSED — ALADIN ∞ C(t) IS LAW")
          PYTEST

      # 4. COMMIT ALL FIXES
      - name: Commit & push fixes
        run: |
          git config user.name "Nobel Bot"
          git config user.email "nobel@aladin.infinity"
          git add .
          git commit -m "Nobel Bot: lint + fix + tests passed — Aladin v∞ v7.0" || echo "Clean"
          git push || echo "No changes"

      # 5. FINAL CHECK — FAIL IF ANYTHING WRONG
      - name: Final strict lint
        run: ruff check proofs --exit-non-zero-on-fix
